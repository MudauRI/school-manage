<!-- filepath: c:\Users\CAPACITI-JHB\Desktop\Student\templates\student_dashboard.html -->
<!-- templates/student_dashboard.html -->
{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Student Dashboard</h2>
    <div class="btn-group">
        <a href="{{ url_for('upload_document') }}" class="btn btn-primary">
            <img src="{{ url_for('static', filename='images/upload.png') }}" alt="Upload" class="btn-icon">
            Upload Document
        </a>
        <a href="{{ url_for('submit_query') }}" class="btn btn-outline-primary">
            <img src="{{ url_for('static', filename='images/query.png') }}" alt="Query" class="btn-icon">
            Submit Query
        </a>
    </div>
</div>

<!-- Student Summary -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card dashboard-card text-white bg-primary">
            <div class="card-body text-center">
                <h5 class="card-title">Student ID</h5>
                <h2 class="card-text">{{ session.student_id }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card dashboard-card text-white bg-success">
            <div class="card-body text-center">
                <h5 class="card-title">Current GPA</h5>
                <h2 class="card-text">{{ gpa }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card dashboard-card text-white bg-info">
            <div class="card-body text-center">
                <h5 class="card-title">Total Credits</h5>
                <h2 class="card-text">{{ total_credits }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card dashboard-card text-white bg-warning">
            <div class="card-body text-center">
                <h5 class="card-title">Completed Subjects</h5>
                <h2 class="card-text">{{ results|length }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Academic Performance -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Academic Performance</h5>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" width="100%" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Academic Summary</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Highest Grade</span>
                    <span class="badge bg-success">
                        {% if results|length > 0 %}
                            {% set highest_grade = results|map(attribute='grade')|max %}
                            {{ highest_grade }}
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Lowest Grade</span>
                    <span class="badge bg-danger">
                        {% if results|length > 0 %}
                            {% set lowest_grade = results|map(attribute='grade')|min %}
                            {{ lowest_grade }}
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Average Grade</span>
                    <span class="badge bg-info">
                        {% set grade_points = {'A': 4.0, 'A-': 3.7, 'B+': 3.3, 'B': 3.0, 'B-': 2.7, 'C+': 2.3, 'C': 2.0, 'C-': 1.7, 'D+': 1.3, 'D': 1.0, 'F': 0.0} %}
                        {% set total_points = 0 %}
                        {% for result in results %}
                            {% set total_points = total_points + grade_points[result.grade] %}
                        {% endfor %}
                        {% set avg_grade = total_points / results|length if results|length > 0 else 0 %}
                        {{ avg_grade|round(2) }}
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Subjects Passed</span>
                    <span class="badge bg-success">
                        {% set passed = [] %}
                        {% for result in results %}
                            {% if result.grade not in ['F', 'D', 'D+'] %}
                                {% set passed = passed + [result] %}
                            {% endif %}
                        {% endfor %}
                        {{ passed|length }}/{{ results|length }}
                    </span>
                </div>
                
                <hr>
                
                <h6>Grade Distribution</h6>
                <div class="d-flex flex-wrap gap-1 mb-3">
                    {% set grades = {'A': 0, 'A-': 0, 'B+': 0, 'B': 0, 'B-': 0, 'C+': 0, 'C': 0, 'C-': 0, 'D+': 0, 'D': 0, 'F': 0} %}
                    {% for result in results %}
                        {% if result.grade in grades %}
                            {% set grades = grades.update({result.grade: grades[result.grade] + 1}) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% for grade, count in grades.items() if count > 0 %}
                        <span class="badge bg-{% if grade in ['A', 'A-', 'B+'] %}success{% elif grade in ['B', 'B-', 'C+'] %}warning{% else %}danger{% endif %}">
                            {{ grade }}: {{ count }}
                        </span>
                    {% endfor %}
                </div>
                
                <a href="{{ url_for('submit_query') }}" class="btn btn-outline-primary btn-sm w-100">
                    <img src="{{ url_for('static', filename='images/request.png') }}" alt="Request" class="btn-icon">
                    Request Transcript
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Academic Results -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Academic Results</h5>
            </div>
            <div class="card-body">
                {% if results %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Course Code</th>
                                <th>Course Name</th>
                                <th>Level</th>
                                <th>Grade</th>
                                <th>Credits</th>
                                <th>Semester</th>
                                <th>Academic Year</th>
                                <th>Remark</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr>
                                <td>{{ result.course_code }}</td>
                                <td>{{ result.course_name }}</td>
                                <td>{{ result.subject_level or 'N/A' }}</td>
                                <td>
                                    {% if result.grade in ['A', 'A-', 'B+'] %}
                                    <img src="{{ url_for('static', filename='images/grade-a.png') }}" alt="A Grade" class="icon"> {{ result.grade }}
                                    {% elif result.grade in ['B', 'B-', 'C+'] %}
                                    <img src="{{ url_for('static', filename='images/grade-b.png') }}" alt="B Grade" class="icon"> {{ result.grade }}
                                    {% elif result.grade in ['C', 'C-'] %}
                                    <img src="{{ url_for('static', filename='images/grade-c.png') }}" alt="C Grade" class="icon"> {{ result.grade }}
                                    {% elif result.grade in ['D+', 'D'] %}
                                    <img src="{{ url_for('static', filename='images/grade-d.png') }}" alt="D Grade" class="icon"> {{ result.grade }}
                                    {% else %}
                                    <img src="{{ url_for('static', filename='images/grade-f.png') }}" alt="F Grade" class="icon"> {{ result.grade }}
                                    {% endif %}
                                </td>
                                <td>{{ result.credits }}</td>
                                <td>{{ result.semester }}</td>
                                <td>{{ result.academic_year }}</td>
                                <td>
                                    {% if result.remark %}
                                    <span class="d-inline-block text-truncate" style="max-width: 150px;" title="{{ result.remark }}">
                                        {{ result.remark }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted">No remark</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center">No results found.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Documents & Notifications -->
    <div class="col-md-4">
        <!-- Uploaded Documents -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Uploaded Documents</h5>
                <a href="{{ url_for('upload_document') }}" class="btn btn-sm btn-primary">
                    <img src="{{ url_for('static', filename='images/add.png') }}" alt="Add" class="btn-icon">
                </a>
            </div>
            <div class="card-body">
                {% if documents %}
                <div class="list-group">
                    {% for doc in documents %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ doc.doc_name }}</h6>
                            <small>{{ doc.upload_date[:10] }}</small>
                        </div>
                        <p class="mb-1">Type: {{ doc.doc_type }}</p>
                        <small>Status: 
                            {% if doc.status == 'Approved' %}
                            <img src="{{ url_for('static', filename='images/status-approved.png') }}" alt="Approved" class="icon"> Approved
                            {% elif doc.status == 'Rejected' %}
                            <img src="{{ url_for('static', filename='images/status-rejected.png') }}" alt="Rejected" class="icon"> Rejected
                            {% else %}
                            <img src="{{ url_for('static', filename='images/status-pending.png') }}" alt="Pending" class="icon"> Pending
                            {% endif %}
                            {% if doc.feedback %}
                            <br>Feedback: {{ doc.feedback }}
                            {% endif %}
                        </small>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center">No documents uploaded yet.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Recent Notifications -->
        <div class="card">
            <div class="card-header">
                <h5>Notifications</h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item px-0 py-2">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Welcome to Student Portal</h6>
                            <small>Today</small>
                        </div>
                        <p class="mb-1 small">You have successfully logged in to your student dashboard.</p>
                    </div>
                    {% if documents %}
                    <div class="list-group-item px-0 py-2">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Document Status</h6>
                            <small>Recently</small>
                        </div>
                        <p class="mb-1 small">You have {{ documents|length }} uploaded document(s).</p>
                    </div>
                    {% endif %}
                    <div class="list-group-item px-0 py-2">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Academic Progress</h6>
                            <small>Ongoing</small>
                        </div>
                        <p class="mb-1 small">You have completed {{ results|length }} subjects with a GPA of {{ gpa }}.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Performance Chart
    const perfCtx = document.getElementById('performanceChart').getContext('2d');
    const performanceChart = new Chart(perfCtx, {
        type: 'bar',
        data: {
            labels: [
                {% for result in results %}
                '{{ result.course_code }}',
                {% endfor %}
            ],
            datasets: [{
                label: 'Grade Points',
                data: [
                    {% for result in results %}
                        {% set grade_point = 0 %}
                        {% if result.grade == 'A' %}
                            {% set grade_point = 4.0 %}
                        {% elif result.grade == 'A-' %}
                            {% set grade_point = 3.7 %}
                        {% elif result.grade == 'B+' %}
                            {% set grade_point = 3.3 %}
                        {% elif result.grade == 'B' %}
                            {% set grade_point = 3.0 %}
                        {% elif result.grade == 'B-' %}
                            {% set grade_point = 2.7 %}
                        {% elif result.grade == 'C+' %}
                            {% set grade_point = 2.3 %}
                        {% elif result.grade == 'C' %}
                            {% set grade_point = 2.0 %}
                        {% elif result.grade == 'C-' %}
                            {% set grade_point = 1.7 %}
                        {% elif result.grade == 'D+' %}
                            {% set grade_point = 1.3 %}
                        {% elif result.grade == 'D' %}
                            {% set grade_point = 1.0 %}
                        {% else %}
                            {% set grade_point = 0.0 %}
                        {% endif %}
                        {{ grade_point }},
                    {% endfor %}
                ],
                backgroundColor: [
                    {% for result in results %}
                        {% if result.grade in ["A", "A-", "B+"] %}
                            '#28a745'
                        {% elif result.grade in ["B", "B-", "C+"] %}
                            '#ffc107'
                        {% else %}
                            '#dc3545'
                        {% endif %},
                    {% endfor %}
                ]
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 4.0,
                    title: {
                        display: true,
                        text: 'Grade Points'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Subjects'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Subject Performance'
                }
            }
        }
    });
</script>
{% endblock %}   